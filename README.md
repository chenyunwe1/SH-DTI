# Spherical harmonics-based deep learning achieves generalized and accurate diffusion tensor imaging

![The overview of SH-DTI](https://github.com/chenyunwe1/SH-DTI/blob/main/Overview.png)

**The overview of SH-DTI**. (a), The training process of SH-DTI. SH-DTI learns the mapping from low-quality spherical harmonics coefficient maps to high-quality diffusion tensor. (b), Experimental design. Extensive experiments were conducted on both simulated and in-vivo datasets, covering various DTI application scenarios.

## **simulated data**

The example data include noise-free diffusion tensor field, noise-free b0 volume, and whole brain mask. These data were generated by one preprocessed data in Massachusetts General Hospital (MGH) Human Connectome Project (HCP) diffusion database. The orginal data is available at https://db.humanconnectome.org/data/projects/MGH_DIFF.

- *diff_parameters.nii.gz* - Contains the noise-free diffusion parameters (non-diffusion weighted s0, and the unique six elements of the diffusion tensor Dxx, Dyy, Dzz, Dxy, Dxz, and Dyz). The data has shape [128, 128, 96, 7], with parameters in the same order as described above.
- *mask.nii.gz*  - The whole brain mask.

## **generate testing data**

Codes for generating testing data.

- *different noise levels* - The noise levels include 0.01, 0.02, and 0.03, respectively.
- *different b values* - The b values include 600, 800, 1000, 1200, and 1500 s/mm<sup>2</sup>, respectively.
- *numbers of DW volumes* - The numbers of DW volumes include 9, 12, 15, 22, and 32, respectively.
- *non-stationary Rician noise* - The noise level varies non-linearly over space within the range of 0.01 to 0.03.



## mk_nf_data.m
The code used for generating the noise-free dMRI data.

**Output**
- *dwi.nii.gz* - Noise-free dMRI data.

## make_train_dataset.py
The code used for preparing the training dataset for the network in SH-DTI.

**Output**
- *training_dataset.tfrecords* - Input and ground-truth data prepared for network.

## make_valid_dataset.py
The code used for preparing the validation  dataset for the network in SH-DTI.

**Output**
- *sph_xxxx.npy* - Input data prepared for network.
- *gt_xxxx.npy* - Ground-truth data prepared for network.

## train.py
The code for training the network in SH-DTI using datasets prepared using the make_train_dataset.py and make_valid_dataset.py scripts. The version of TensorFlow-GPU is 2.3.0.

**Output**
- *model_xxx.h5* - The model saved every five training iterations.

## Trained model
Due to the 25MB file upload limit, the trained model cannot be uploaded. If you need, please download it at https://drive.google.com/file/d/1103ntSQ3KYY8AHoJO_Bbak2-tcA9dncY/view?usp=drive_link.

## calculate_sh_coe.py
The code for calculating the spherical harmonics coefficient maps

**Output**
- *tensor.nii.gz* - The spherical harmonics coefficient maps.

## test.py
The code for tesing the trained SH-DTI model. The version of TensorFlow-GPU is 2.3.0.

**Output**
- *tensor.nii.gz* - The estimated diffusion tensor (Dxx, Dyy, Dzz, Dxy, Dxz, and Dyz) with a shape of [x, y, z, 6]. 
